<!-- templates/admin_all_users.html -->
{% extends 'admin_base.html' %}
{% load humanize %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
<div class="glass-card rounded-2xl mb-4 sm:mb-8">
    <div class="px-4 sm:px-6 py-6 sm:py-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 space-y-4 sm:space-y-0">
            <div class="text-center sm:text-left">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">All Registered Users</h1>
                <p class="text-xl sm:text-2xl text-gray-600">Total: {{ total_users|intcomma }} Users</p>
            </div>
            <a href="{% url 'admin_dashboard' %}" 
               class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 sm:px-4 sm:py-2 rounded-lg transition-colors flex items-center justify-center space-x-2 w-full sm:w-auto">
                <i class="fas fa-arrow-left"></i>
                <span class="text-sm sm:text-base">Back to Dashboard</span>
            </a>
        </div>
    </div>
</div>

    <!-- Search and Filters Card -->
    <div class="glass-card rounded-2xl mb-8">
        <div class="p-6">
            <form method="get" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-search mr-2"></i>Search Users
                        </label>
                        <input type="text" 
                               name="search" 
                               value="{{ search_query }}"
                               placeholder="Search by username, email..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <!-- Plan Type Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-crown mr-2"></i>Filter by Plan
                        </label>
                        <select name="plan_type" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Plans</option>
                            <option value="free" {% if plan_filter == 'free' %}selected{% endif %}>Free Plan</option>
                            <option value="paid" {% if plan_filter == 'paid' %}selected{% endif %}>All Paid Plans</option>
                            {% for plan_type in plan_types %}
                                {% if plan_type != 'free' %}  <!-- Hide duplicate free plans -->
                                <option value="{{ plan_type }}" {% if plan_filter == plan_type %}selected{% endif %}>
                                    {{ plan_type|title }} Plan
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Active Status Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-clock mr-2"></i>Active Status
                        </label>
                        <select name="active" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Users</option>
                            <option value="active" {% if active_filter == 'active' %}selected{% endif %}>Active Today</option>
                            <option value="inactive" {% if active_filter == 'inactive' %}selected{% endif %}>Inactive (30+ days or Never)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                    <div class="text-gray-600 text-sm">
                        {% if search_query or plan_filter or active_filter %}
                        <i class="fas fa-filter mr-2"></i>
                        Showing {{ page_obj.paginator.count }} filtered users
                        {% endif %}
                    </div>
                    <div class="flex space-x-3">
                        <button type="submit" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 transition-colors">
                            <i class="fas fa-filter"></i>
                            <span>Apply Filters</span>
                        </button>
                        <a href="{% url 'all_users' %}" 
                           class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium flex items-center space-x-2 transition-colors">
                            <i class="fas fa-redo"></i>
                            <span>Reset</span>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Users Table with anchor -->
    <div id="users-results" class="glass-card rounded-2xl">
        <div class="px-6 py-6 border-b border-gray-200/50">
            <h2 class="text-xl font-bold text-gray-800">
                Users List 
                <span class="text-gray-600 text-sm font-normal">
                    ({{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }})
                </span>
            </h2>
            
            <!-- Active Filter Summary -->
            {% if active_filter %}
            <div class="mt-2">
                {% if active_filter == 'active' %}
                <span class="px-3 py-1 text-sm bg-green-100 text-green-800 rounded-full">
                    <i class="fas fa-check-circle mr-1"></i>Showing users active today
                </span>
                {% elif active_filter == 'inactive' %}
                <span class="px-3 py-1 text-sm bg-gray-100 text-gray-800 rounded-full">
                    <i class="fas fa-clock mr-1"></i>Showing inactive users (30+ days or never logged in)
                </span>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Plan Filter Summary -->
            {% if plan_filter %}
            <div class="mt-2">
                {% if plan_filter == 'free' %}
                <span class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full">
                    <i class="fas fa-user mr-1"></i>Showing Free Plan users
                </span>
                {% elif plan_filter == 'paid' %}
                <span class="px-3 py-1 text-sm bg-purple-100 text-purple-800 rounded-full">
                    <i class="fas fa-crown mr-1"></i>Showing all Paid Plan users
                </span>
                {% else %}
                <span class="px-3 py-1 text-sm bg-orange-100 text-orange-800 rounded-full">
                    <i class="fas fa-star mr-1"></i>Showing {{ plan_filter|title }} Plan users
                </span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <div class="p-6">
            {% if page_obj %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-lg font-medium font-bold text-gray-900 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-lg font-medium font-bold text-gray-900 uppercase tracking-wider">Plan</th>
                            <th class="px-6 py-3 text-left text-lg font-medium font-bold text-gray-900 uppercase tracking-wider">Storage Used</th>
                            <th class="px-6 py-3 text-left text-lg font-medium font-bold text-gray-900 uppercase tracking-wider">Joined Date</th>
                            <th class="px-6 py-3 text-left text-lg font-medium font-bold text-gray-900 uppercase tracking-wider">Last Login</th>
                            <th class="px-6 py-3 text-left text-lg font-medium font-bold text-gray-900 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for user in page_obj %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                        <i class="fas fa-user text-white text-xs"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900">{{ user.username }}</div>
                                        <div class="text-sm text-gray-600">{{ user.email }}</div>
                                        {% if user.first_name or user.last_name %}
                                        <div class="text-xs text-gray-500">{{ user.first_name }} {{ user.last_name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-medium rounded-full 
                                    {% if user.userprofile.storage_plan.plan_type == 'pro' %}bg-purple-100 text-purple-800
                                    {% elif user.userprofile.storage_plan.plan_type == 'basic' %}bg-blue-100 text-blue-800
                                    {% elif user.userprofile.storage_plan.plan_type == 'enterprise' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ user.userprofile.storage_plan.name|default:"Free" }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ user.userprofile.used_storage|filesizeformat }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                {{ user.date_joined|date:"M d, Y" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                {{ user.last_login|date:"M d, Y"|default:"Never" }}
                            </td>

<td class="px-6 py-4 whitespace-nowrap">
    {% if user.last_login %}
        {% if user.last_login.date == current_date %}
        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
            Active Today
        </span>
        {% else %}
            {% comment %} Calculate days since last login {% endcomment %}
            {% with days_since_login=user.last_login.date|timesince:current_date %}
            {% if "day" in days_since_login %}
                {% with days=days_since_login.split|first %}
                    {% if days <= 30 %}
                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                        Active
                    </span>
                    {% else %}
                    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">
                        Inactive
                    </span>
                    {% endif %}
                {% endwith %}
            {% else %}
            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                Active
            </span>
            {% endif %}
            {% endwith %}
        {% endif %}
    {% else %}
    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">
        Never Logged In
    </span>
    {% endif %}
</td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 text-lg">No users found</p>
                <p class="text-gray-500 mt-2">Try adjusting your search or filters</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="glass-card rounded-2xl mt-6">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }} users
                </div>
                <div class="flex space-x-2">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if plan_filter %}&plan_type={{ plan_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}#users-results" 
                       class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Previous
                    </a>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <span class="px-4 py-2 bg-blue-500 text-white rounded-lg">
                            {{ num }}
                        </span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if plan_filter %}&plan_type={{ plan_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}#users-results" 
                           class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                            {{ num }}
                        </a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if plan_filter %}&plan_type={{ plan_filter }}{% endif %}{% if active_filter %}&active={{ active_filter }}{% endif %}#users-results" 
                       class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Next
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript to maintain scroll position -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have filter parameters and scroll to results
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('search') || urlParams.has('plan_type') || urlParams.has('active')) {
        setTimeout(() => {
            const resultsSection = document.getElementById('users-results');
            if (resultsSection) {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    }
});
</script>
{% endblock %}